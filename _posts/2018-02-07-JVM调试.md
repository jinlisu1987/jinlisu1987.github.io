---
layout:     post
title:      JVM 调试
subtitle:   JVM 调试
date:       2018-02-07
author:     susu
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - VisualVM
    - jstack
    - greys
---

# greys 排查线上某一个方法执行失败案例

使用场景: 

类HankService 类的updateHsfServices方法执行失败， 假如是线上环境，日志也没有输出，不许debug，如何排查问题。

http://blog.csdn.net/north_eagle/article/details/45097509

http://blog.csdn.net/zhengyong15984285623/article/details/60762863

https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf

# 线上排查CPU飙高问题的方式

该方法的缺点是只能拿到瞬时值，没办法统计一段时间的线程CPU消耗的情况，具有一定的偶然性

## 1. 拿到进程PID

ps -ef \| grep java

```
agent      5587      1  0 Jan25 ?        00:16:41 /opt/taobao/java/bin/java -cp /home/staragent/plugins/sunfire-agent.src/sunfire-agent.cur/lib/* -Djava.library.path=/home/staragent/plugins/sunfire-agent.src/sunfire-agent.cur/jni -Xmx100m -Xms100m -XX:+UseParallelGC -XX:MaxDirectMemorySize=50m -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/home/agent/sunfire/logs/gc.log com.alibaba.sunfire.agent.Main
admin     60391  25424  0 18:03 pts/1    00:00:00 grep java
admin    203062      1 99 15:35 ?        04:53:55 /opt/taobao/java/bin/java -cp /home/admin/monitor-store-service/lib/* -Xms6096m -Xmx6096m -Xmn2800m -XX:CICompilerCount=8 -XX:+PrintCodeCache -XX:ArrayAllocationWarningSize=25m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=512m -Xss256k -XX:AutoBoxCacheMax=20000 -XX:-UseBiasedLocking -XX:+UseConcMarkSweepGC -XX:+CMSParallelFullGC -XX:ParallelGCThreads=8 -XX:MaxTenuringThreshold=15 -XX:+UseParNewGC -XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection -XX:+CMSPermGenSweepingEnabled -XX:CMSInitiatingOccupancyFraction=80 -XX:+CMSClassUnloadingEnabled -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/admin/sunfire/heapdump.bin -Xloggc:/home/admin/logs/app/gc.log -XX:ErrorFile=/home/admin//logs/app/hs_err_pid%p.log -XX:+ExplicitGCInvokesConcurrent -XX:-OmitStackTraceInFastThrow com.alibaba.monitor.store.server.netty.MainServer
```
PID: 203062

## 2. 查看某一个进程下各线程的CPU消耗情况

top -H -p 203062

```
   PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
203142 admin     20   0 8088m 4.8g  15m R 38.9 60.4  68:40.59 java
203117 admin     20   0 8088m 4.8g  15m R 25.3 60.4  27:05.66 java
203116 admin     20   0 8088m 4.8g  15m R 17.0 60.4  28:32.04 java
203115 admin     20   0 8088m 4.8g  15m R 14.3 60.4  29:04.14 java
203118 admin     20   0 8088m 4.8g  15m S 11.0 60.4  28:15.04 java
203147 admin     20   0 8088m 4.8g  15m S  9.3 60.4   8:19.57 java
203146 admin     20   0 8088m 4.8g  15m S  5.3 60.4   9:31.28 java
203144 admin     20   0 8088m 4.8g  15m S  5.0 60.4   9:40.56 java
203145 admin     20   0 8088m 4.8g  15m S  3.3 60.4   9:43.54 java
203123 admin     20   0 8088m 4.8g  15m S  3.0 60.4   4:20.39 java
```

找到线程消耗CPU比较大的PID

如: 203142

## 3. 通过线程PID确认相应的具体线程

/opt/taobao/java/bin/jstack 203062 | grep \`printf "%x" 203142\` -A 15

```
"pool-1-batch-put-thread-1" #47 prio=5 os_prio=0 tid=0x00007f19cc29d750 nid=0x31986 runnable [0x00000000414b7000]
   java.lang.Thread.State: RUNNABLE
  at com.alibaba.fastjson.serializer.SerializeConfig.getObjectWriter(SerializeConfig.java:400)
  at com.alibaba.fastjson.serializer.JSONSerializer.getObjectWriter(JSONSerializer.java:359)
  at com.alibaba.fastjson.serializer.ListSerializer.write(ListSerializer.java:129)
  at com.alibaba.fastjson.serializer.JSONSerializer.write(JSONSerializer.java:278)
  at com.alibaba.fastjson.JSON.toJSONString(JSON.java:587)
  at com.alibaba.fastjson.JSON.toJSONString(JSON.java:576)
  at com.alibaba.hitsdb.client.consumer.BatchPutRunnable.serialize(BatchPutRunnable.java:244)
  at com.alibaba.hitsdb.client.consumer.BatchPutRunnable.run(BatchPutRunnable.java:167)
  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
  at java.util.concurrent.FutureTask.run(FutureTask.java:266)
  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1152)
  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:627)
  at java.lang.Thread.run(Thread.java:852)
```

# 本地调试比较棒的工具: VisualVM

https://www.ibm.com/developerworks/cn/java/j-lo-visualvm/

https://segmentfault.com/a/1190000004435704




